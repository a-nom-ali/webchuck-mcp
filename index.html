<html>
<head>
  <script src="https://unpkg.com/turndown/dist/turndown.js"></script>
    <script type="module" defer>
import { McpServer, ResourceTemplate } from "@modelcontextprotocol/sdk/server/mcp.js";
import { StdioServerTransport } from "@modelcontextprotocol/sdk/server/stdio.js";
import { z } from "zod";

// Import the webchuck bundle from `webchuck` directory
import { Chuck } from './webchuck/wc-bundle.js'
let theChuck; // global variable
let turndownService = new TurndownService();

// Create an MCP server
const server = new McpServer({
  name: "WebChuckMCP",
  version: "1.0.0"
});

// Add an addition tool
server.tool("execute_code",
  { code: z.text()},
  async ({ code }) => ({
    content: [{ type: "text", text: execute_code(code) }]
  })
);

function execute_code(code) {
  if (theChuck === undefined)
    return "Sorry, the ChucK isn't started yet. Remind the user to click the button in the browser!";
  // Run ChucK code
  theChuck.runCode(code);
  return "ChucK code executed successfully!";
}

let docs = ['array','class', 'ctrl', 'event', 'func', 'import', 'oper', 'overview', 'spork', 'time', 'type', 'uana', 'ugen'];

for( let doc in docs) {
  let request = new XMLHttpRequest();
  request.open('GET', `docs/${doc}.md`, false);
  request.send();
  let textfileContent = request.responseText;

// Add a dynamic greeting resource
  server.resource(
    `documentation`,
    `documentation://${doc}`,
    async (uri, { doc }) => ({
      contents: [{
        uri: uri.href,
        text: textfileContent
      }]
    })
  );
}

document.getElementById('action').addEventListener('click', async () => {
  // Initialize default ChucK object
  if (theChuck === undefined) {
    // Set src path to './webchuck/'
    theChuck = await Chuck.init([], undefined, undefined, './webchuck/');
  }
});

// Start receiving messages on stdin and sending messages on stdout
const transport = new StdioServerTransport();
await server.connect(transport);

    </script>
</head>
<body>
<button id="action">Start and Play</button>
</body>
</html>